name: Coverage

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      baseline_coverage:
        description: "Manual baseline coverage % (for testing)"
        required: false
        default: "0"

env:
  CARGO_TERM_COLOR: always

jobs:
  coverage:
    runs-on: ubuntu-latest
    name: Test Coverage
    permissions:
      contents: read
      pull-requests: write  # Required for PR comments

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: coverage

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate coverage
        run: |
          echo "=== Generating Coverage Report ==="
          mkdir -p coverage

          # Run tests with coverage for all feature combinations
          cargo llvm-cov --all-features --workspace --no-report
          cargo llvm-cov --no-default-features --workspace --no-report
          cargo llvm-cov --no-default-features --features mip04 --workspace --no-report

          # Generate all report formats from the merged coverage data
          cargo llvm-cov report --lcov --output-path coverage/lcov.info
          cargo llvm-cov report --html --output-dir coverage/html
          cargo llvm-cov report | tee coverage/summary.txt

          echo ""
          echo "=== Coverage Summary ==="
          cat coverage/summary.txt

      - name: Extract coverage percentage
        id: coverage
        run: |
          chmod +x scripts/extract-coverage.sh
          COVERAGE=$(./scripts/extract-coverage.sh coverage/lcov.info)
          echo "percentage=$COVERAGE" >> "$GITHUB_OUTPUT"
          echo "Current coverage: $COVERAGE%"

      - name: Get master branch coverage (for PRs)
        if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        id: master_coverage
        run: |
          # Check if manual baseline provided (for testing)
          if [ -n "${{ github.event.inputs.baseline_coverage }}" ]; then
            MASTER_COV="${{ github.event.inputs.baseline_coverage }}"
            echo "baseline=$MASTER_COV" >> "$GITHUB_OUTPUT"
            echo "Using manual baseline: $MASTER_COV%"
          else
            echo "üîç Searching for baseline from master branch..."
            
            # Get the latest completed coverage workflow run ID from master
            RUN_ID=$(gh run list \
              --repo ${{ github.repository }} \
              --workflow=coverage.yml \
              --branch master \
              --status completed \
              --limit 1 \
              --json databaseId \
              --jq '.[0].databaseId')
            
            if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
              echo "baseline=0" >> "$GITHUB_OUTPUT"
              echo "‚ö†Ô∏è  No completed coverage workflow run found on master"
              exit 0
            fi
            
            echo "Found workflow run ID: $RUN_ID"
            
            # Download the baseline artifact from that specific run
            if gh run download "$RUN_ID" \
              --repo ${{ github.repository }} \
              --name coverage-baseline \
              --dir master-coverage; then
              
              if [ -f master-coverage/coverage-baseline.txt ]; then
                MASTER_COV=$(cat master-coverage/coverage-baseline.txt)
                echo "baseline=$MASTER_COV" >> "$GITHUB_OUTPUT"
                echo "‚úì Master branch coverage: $MASTER_COV%"
              else
                echo "baseline=0" >> "$GITHUB_OUTPUT"
                echo "‚ö†Ô∏è  Baseline file not found in artifact"
              fi
            else
              echo "baseline=0" >> "$GITHUB_OUTPUT"
              echo "‚ö†Ô∏è  Failed to download baseline artifact from run $RUN_ID"
            fi
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Compare coverage
        if: (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch') && steps.master_coverage.outputs.baseline != '0'
        run: |
          CURRENT=${{ steps.coverage.outputs.percentage }}
          BASELINE=${{ steps.master_coverage.outputs.baseline }}

          echo "=== Coverage Comparison ==="
          echo "Master branch: $BASELINE%"
          echo "This PR:       $CURRENT%"

          DIFF=$(awk "BEGIN {printf \"%.2f\", $CURRENT - $BASELINE}")

          if (( $(awk "BEGIN {print ($CURRENT < $BASELINE)}") )); then
            echo "‚ùå Coverage decreased by $DIFF%"
            echo "::error::Coverage regression detected. Coverage decreased from $BASELINE% to $CURRENT% (-$DIFF%)"
            exit 1
          elif (( $(awk "BEGIN {print ($CURRENT > $BASELINE)}") )); then
            echo "‚úÖ Coverage improved by $DIFF%"
          else
            echo "‚úÖ Coverage maintained at $BASELINE%"
          fi

      - name: Comment PR with coverage change
        if: always() && github.event_name == 'pull_request' && steps.master_coverage.outputs.baseline != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const current = parseFloat('${{ steps.coverage.outputs.percentage }}');
            const baseline = parseFloat('${{ steps.master_coverage.outputs.baseline }}');
            const diff = (current - baseline).toFixed(2);
            
            let emoji = current > baseline ? '‚úÖ' : current < baseline ? '‚ùå' : '‚ö†Ô∏è';
            
            const body = `## ${emoji} Coverage: ${baseline}% ‚Üí ${current}% (${diff > 0 ? '+' : ''}${diff}%)`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Save coverage baseline (master only)
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          mkdir -p coverage-baseline
          echo "${{ steps.coverage.outputs.percentage }}" > coverage-baseline/coverage-baseline.txt
          echo "Saved baseline: ${{ steps.coverage.outputs.percentage }}%"

      - name: Upload coverage baseline (master only)
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-baseline
          path: coverage-baseline/coverage-baseline.txt
          retention-days: 90

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-html
          path: coverage/html/
          retention-days: 90

      - name: Upload lcov coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-lcov
          path: coverage/lcov.info
          retention-days: 90

      - name: Upload coverage summary
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          path: coverage/summary.txt
          retention-days: 90
